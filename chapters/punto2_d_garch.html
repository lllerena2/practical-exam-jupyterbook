
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>IMPLEMENTACION GARCH PARA VOLATILIDAD &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/punto2_d_garch';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Modelos de Deep Learning" href="deeplearning.html" />
    <link rel="prev" title="Parcial Punto 2 - VOLATILIDAD" href="punto2_c_volatilidad.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <img src="../_static/logo.png" class="logo__image only-dark pst-js-only" alt="My sample book - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to your Jupyter Book
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../markdown.html">Markdown Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="punto2_a_price.html">Parcial Punto 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="punto2_b_retorno.html">Parcial Punto 2 - RETORNO</a></li>
<li class="toctree-l1"><a class="reference internal" href="punto2_c_volatilidad.html">Parcial Punto 2 - VOLATILIDAD</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">IMPLEMENTACION GARCH PARA VOLATILIDAD</a></li>
<li class="toctree-l1"><a class="reference internal" href="deeplearning.html">Modelos de Deep Learning</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fchapters/punto2_d_garch.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/chapters/punto2_d_garch.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>IMPLEMENTACION GARCH PARA VOLATILIDAD</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#librerias-y-funciones">LIBRERIAS Y FUNCIONES</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#datos">DATOS</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#garch-sin-rolling">GARCH SIN ROLLING</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#implementacion">IMPLEMENTACIÓN</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#testing">TESTING</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#garch-con-rolling">GARCH CON ROLLING</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="implementacion-garch-para-volatilidad">
<h1>IMPLEMENTACION GARCH PARA VOLATILIDAD<a class="headerlink" href="#implementacion-garch-para-volatilidad" title="Link to this heading">#</a></h1>
<section id="librerias-y-funciones">
<h2>LIBRERIAS Y FUNCIONES<a class="headerlink" href="#librerias-y-funciones" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># Evaluación de modelos</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">mean_absolute_percentage_error</span><span class="p">,</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span>

<span class="c1"># Modelos de series de tiempo y estadística</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.holtwinters</span> <span class="kn">import</span> <span class="n">SimpleExpSmoothing</span><span class="p">,</span> <span class="n">ExponentialSmoothing</span><span class="p">,</span> <span class="n">Holt</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.arima.model</span> <span class="kn">import</span> <span class="n">ARIMA</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa</span> <span class="kn">import</span> <span class="n">stattools</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.stattools</span> <span class="kn">import</span> <span class="n">jarque_bera</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.diagnostic</span> <span class="kn">import</span> <span class="n">acorr_ljungbox</span>
<span class="kn">from</span> <span class="nn">statsmodels.graphics.tsaplots</span> <span class="kn">import</span> <span class="n">plot_predict</span><span class="p">,</span> <span class="n">plot_acf</span>
<span class="kn">from</span> <span class="nn">pandas.plotting</span> <span class="kn">import</span> <span class="n">autocorrelation_plot</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="c1"># Modelos ARCH/GARCH</span>
<span class="kn">from</span> <span class="nn">arch</span> <span class="kn">import</span> <span class="n">arch_model</span>

<span class="c1"># Visualización</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>

<span class="c1"># Barra de progreso</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># Ignorar advertencias de convergencia y otros warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">forecast_accuracy</span><span class="p">(</span><span class="n">forecast</span><span class="p">,</span> <span class="n">actual</span><span class="p">,</span> <span class="n">str_name</span><span class="p">,</span> <span class="n">str_model</span><span class="p">,</span> <span class="n">lj_lags</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="n">window_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
    <span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">forecast</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">actual</span><span class="p">))</span>    <span class="c1"># MAPE</span>
    <span class="n">mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">forecast</span> <span class="o">-</span> <span class="n">actual</span><span class="p">))</span>                      <span class="c1"># MAE</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">forecast</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>                       <span class="c1"># MSE</span>
    <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>                                           <span class="c1"># RMSE</span>

    <span class="c1"># Cálculo del R²</span>
    <span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">actual</span> <span class="o">-</span> <span class="n">forecast</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ss_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">actual</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">actual</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ss_res</span> <span class="o">/</span> <span class="n">ss_tot</span><span class="p">)</span>

    <span class="c1"># Cálculo de los residuales</span>
    <span class="n">residuals</span> <span class="o">=</span> <span class="n">actual</span> <span class="o">-</span> <span class="n">forecast</span>

    <span class="c1"># Prueba de Ljung-Box</span>
    <span class="n">lb_test</span> <span class="o">=</span> <span class="n">acorr_ljungbox</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="n">lj_lags</span><span class="p">,</span> <span class="n">return_df</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">lb_pvalue</span> <span class="o">=</span> <span class="n">lb_test</span><span class="p">[</span><span class="s1">&#39;lb_pvalue&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># p-valor en el lag máximo especificado (10 en este caso)</span>

    <span class="c1"># Prueba de Jarque-Bera</span>
    <span class="n">jb_stat</span><span class="p">,</span> <span class="n">jb_pvalue</span><span class="p">,</span> <span class="n">skew</span><span class="p">,</span> <span class="n">kurtosis</span> <span class="o">=</span> <span class="n">jarque_bera</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>

    <span class="n">df_acc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">str_model</span><span class="p">,</span>
        <span class="s1">&#39;window&#39;</span><span class="p">:</span> <span class="n">window_str</span><span class="p">,</span>
        <span class="s1">&#39;MAE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">mae</span><span class="p">],</span>
        <span class="s1">&#39;MSE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">mse</span><span class="p">],</span>
        <span class="s1">&#39;MAPE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">mape</span><span class="p">],</span>
        <span class="s1">&#39;RMSE&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">rmse</span><span class="p">],</span>
        <span class="s1">&#39;R2&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">r2</span><span class="p">],</span>
        <span class="s1">&#39;Ljung-Box p-value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">lb_pvalue</span><span class="p">],</span>
        <span class="s1">&#39;Jarque-Bera p-value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">jb_pvalue</span><span class="p">]</span>
    <span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">str_name</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">df_acc</span>


<span class="k">def</span> <span class="nf">train_val_test</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">window</span><span class="p">):</span>
  <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
  <span class="n">train_len</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">56</span> <span class="c1"># El profesor indicó que este siempre era el tamano del training (28+28)</span>
  <span class="n">val_set_end</span> <span class="o">=</span> <span class="n">train_len</span> <span class="o">+</span> <span class="n">window</span>
  <span class="n">test_set_end</span> <span class="o">=</span> <span class="n">val_set_end</span> <span class="o">+</span> <span class="n">window</span>
  

  <span class="n">train_set</span> <span class="o">=</span> <span class="n">df</span><span class="p">[:</span><span class="n">train_len</span><span class="p">]</span>
  <span class="n">val_set</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">train_len</span><span class="p">:</span> <span class="n">val_set_end</span><span class="p">]</span>
  <span class="n">test_set</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">val_set_end</span><span class="p">:</span> <span class="n">test_set_end</span><span class="p">]</span>

  <span class="k">return</span> <span class="n">train_set</span><span class="p">,</span> <span class="n">val_set</span><span class="p">,</span> <span class="n">test_set</span>

<span class="c1">#Implemementacion de retorno</span>
<span class="c1"># retorno acumulado</span>
<span class="k">def</span> <span class="nf">retorno_acumulado</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columna</span><span class="p">):</span>
    <span class="n">retorno_diario</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">columna</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="n">columna</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">retorno_diario</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">volatilidad</span><span class="p">(</span><span class="n">retorno_acum</span><span class="p">,</span> <span class="n">ventana</span><span class="p">):</span>
    <span class="n">std_w</span> <span class="o">=</span> <span class="n">retorno_acum</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="n">window</span><span class="o">=</span><span class="n">ventana</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">std_w</span>

<span class="k">def</span> <span class="nf">plot_model</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>

    <span class="c1"># Prepare the data</span>
    <span class="n">train_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Time&#39;</span><span class="p">:</span> <span class="n">train</span><span class="p">[</span><span class="o">-</span><span class="mi">300</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">train</span><span class="p">[</span><span class="o">-</span><span class="mi">300</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="s1">&#39;Category&#39;</span><span class="p">:</span> <span class="s1">&#39;Train&#39;</span>
    <span class="p">})</span>
    <span class="n">val_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Time&#39;</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">val</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="s1">&#39;Category&#39;</span><span class="p">:</span> <span class="s1">&#39;Validation&#39;</span>
    <span class="p">})</span>
    <span class="n">test_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Time&#39;</span><span class="p">:</span> <span class="n">test</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">test</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="s1">&#39;Category&#39;</span><span class="p">:</span> <span class="s1">&#39;Test&#39;</span>
    <span class="p">})</span>
    <span class="n">y_pred_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;Time&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
        <span class="s1">&#39;Value&#39;</span><span class="p">:</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="s1">&#39;Category&#39;</span><span class="p">:</span> <span class="s1">&#39;Prediction&#39;</span>
    <span class="p">})</span>

    <span class="c1"># Combine the data</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train_df</span><span class="p">,</span> <span class="n">val_df</span><span class="p">,</span> <span class="n">test_df</span><span class="p">,</span> <span class="n">y_pred_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Add line dash style</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Dash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">({</span>
        <span class="s1">&#39;Train&#39;</span><span class="p">:</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Validation&#39;</span><span class="p">:</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Test&#39;</span><span class="p">:</span> <span class="s1">&#39;solid&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Prediction&#39;</span><span class="p">:</span> <span class="s1">&#39;dash&#39;</span>
    <span class="p">})</span>

    <span class="c1"># Compute MAE</span>
    <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

    <span class="c1"># Plot using Plotly Express</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span>
        <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Value&#39;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;Category&#39;</span><span class="p">,</span>
        <span class="n">line_dash</span><span class="o">=</span><span class="s1">&#39;Dash&#39;</span><span class="p">,</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">, MAE: </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">mae</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">color_discrete_map</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;Train&#39;</span><span class="p">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Validation&#39;</span><span class="p">:</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Test&#39;</span><span class="p">:</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Prediction&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Time&#39;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Value&#39;</span><span class="p">,</span>
        <span class="n">legend_title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="n">template</span><span class="o">=</span><span class="s1">&#39;plotly_white&#39;</span>
    <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">20</span>
<span class="g g-Whitespace">     </span><span class="mi">17</span> <span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span> <span class="c1"># Modelos ARCH/GARCH</span>
<span class="ne">---&gt; </span><span class="mi">20</span> <span class="kn">from</span> <span class="nn">arch</span> <span class="kn">import</span> <span class="n">arch_model</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span> <span class="c1"># Visualización</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span> <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;arch&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="datos">
<h2>DATOS<a class="headerlink" href="#datos" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Data Original</span>
<span class="n">data_init</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;https://raw.githubusercontent.com/lihkir/Data/refs/heads/main/Bitcoin%20Historical%20Data.csv&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
<span class="c1"># Se crea una copia de la data para manipulación</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">data_init</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="c1"># Solo nos quedamos con las columnas Date y Price</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Price&#39;</span><span class="p">]]</span>

<span class="c1"># Se elimina las comas de Price para poder convertirlo a números</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

<span class="c1">#Convertimos las columnas price en números y date en fecha</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Price&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">])</span>

<span class="c1">#Creo la nueva columna</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;DailyReturn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">retorno_acumulado</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s2">&quot;Price&quot;</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Volatility&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">volatilidad</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;DailyReturn&quot;</span><span class="p">],</span> <span class="mi">7</span><span class="p">)</span>

<span class="c1"># Se hace que el indice sea la columna Date</span>
<span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span>
<span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">df_copy</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">timeserie</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Volatility&quot;</span><span class="p">]</span>
<span class="n">timeserie</span> <span class="o">=</span> <span class="n">timeserie</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="garch-sin-rolling">
<h3>GARCH SIN ROLLING<a class="headerlink" href="#garch-sin-rolling" title="Link to this heading">#</a></h3>
<section id="implementacion">
<h4>IMPLEMENTACIÓN<a class="headerlink" href="#implementacion" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">21</span><span class="p">,</span><span class="mi">28</span><span class="p">]</span>

<span class="c1"># Función para ajustar un modelo GARCH y generar pronósticos de la varianza</span>
<span class="k">def</span> <span class="nf">garch_forecast_variance</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">mean_model</span><span class="o">=</span><span class="s1">&#39;HAR&#39;</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ajusta un modelo GARCH con los parámetros especificados y genera pronósticos de la varianza para el conjunto de prueba.</span>
<span class="sd">    </span>
<span class="sd">    Parámetros:</span>
<span class="sd">    - train (pd.Series): Serie temporal de entrenamiento.</span>
<span class="sd">    - test (pd.Series): Serie temporal de prueba (debe contener las varianzas reales).</span>
<span class="sd">    - p (int): Orden ARCH.</span>
<span class="sd">    - o (int): Orden de términos asimétricos (Leverage term).</span>
<span class="sd">    - q (int): Orden GARCH.</span>
<span class="sd">    - mean_model (str): Modelo para la media (&#39;Constant&#39;, &#39;AR&#39;, &#39;HAR&#39;, etc.).</span>
<span class="sd">    - lags (int): Número de lags para el modelo HAR.</span>
<span class="sd">    - dist (str): Distribución de los residuos (&#39;Normal&#39;, &#39;t&#39;, etc.).</span>
<span class="sd">    - rescale (bool): Si se debe reescalar los datos.</span>
<span class="sd">    </span>
<span class="sd">    Retorna:</span>
<span class="sd">    - predicted_variance (np.ndarray): Pronósticos de la varianza condicional.</span>
<span class="sd">    - mae (float): Error Absoluto Medio entre las varianzas pronosticadas y las reales.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Configurar el modelo GARCH</span>
        <span class="n">am</span> <span class="o">=</span> <span class="n">arch_model</span><span class="p">(</span>
            <span class="n">train</span><span class="p">,</span>
            <span class="n">mean</span><span class="o">=</span><span class="n">mean_model</span><span class="p">,</span>
            <span class="n">vol</span><span class="o">=</span><span class="s1">&#39;Garch&#39;</span><span class="p">,</span>
            <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
            <span class="n">o</span><span class="o">=</span><span class="n">o</span><span class="p">,</span>
            <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span>
            <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
            <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
            <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span>
        <span class="p">)</span>
        
        <span class="c1"># Ajustar el modelo</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">am</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        
        <span class="c1"># Generar pronósticos para el horizonte igual al tamaño del conjunto de prueba</span>
        <span class="n">forecasts</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">horizon</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
        
        <span class="c1"># Extraer las predicciones de la varianza condicional</span>
        <span class="c1"># forecasts.variance tiene un MultiIndex: (variable, horizon)</span>
        <span class="c1"># Para obtener las varianzas a un paso adelante, usamos &#39;h.1&#39;</span>
        <span class="c1"># Sin embargo, para múltiples pasos, necesitamos extraer adecuadamente</span>
        <span class="c1"># Aquí, extraemos la varianza para cada paso desde h.1 hasta h.n</span>
        <span class="n">predicted_variance</span> <span class="o">=</span> <span class="n">forecasts</span><span class="o">.</span><span class="n">variance</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
        
        <span class="c1"># Asegurarse de que el número de predicciones coincida con el conjunto de prueba</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">predicted_variance</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
            <span class="n">predicted_variance</span> <span class="o">=</span> <span class="n">forecasts</span><span class="o">.</span><span class="n">variance</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="p">)]</span>
        
        <span class="c1"># Calcular el MAE</span>
        <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">predicted_variance</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">predicted_variance</span><span class="p">,</span> <span class="n">mae</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error con p=</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">, o=</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">, q=</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

<span class="c1"># Función para optimizar los hiperparámetros GARCH</span>
<span class="k">def</span> <span class="nf">garch_optimizer_variance</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">p_range</span><span class="p">,</span> <span class="n">o_range</span><span class="p">,</span> <span class="n">q_range</span><span class="p">,</span> <span class="n">mean_model</span><span class="o">=</span><span class="s1">&#39;HAR&#39;</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Optimiza los parámetros p, o, q del modelo GARCH buscando minimizar el MAE de las varianzas.</span>
<span class="sd">    </span>
<span class="sd">    Parámetros:</span>
<span class="sd">    - train (pd.Series): Serie temporal de entrenamiento.</span>
<span class="sd">    - test (pd.Series): Serie temporal de prueba (debe contener las varianzas reales).</span>
<span class="sd">    - p_range (iterable): Rango de valores para el parámetro p.</span>
<span class="sd">    - o_range (iterable): Rango de valores para el parámetro o.</span>
<span class="sd">    - q_range (iterable): Rango de valores para el parámetro q.</span>
<span class="sd">    - mean_model (str): Modelo para la media (&#39;Constant&#39;, &#39;AR&#39;, &#39;HAR&#39;, etc.).</span>
<span class="sd">    - lags (int): Número de lags para el modelo HAR.</span>
<span class="sd">    - dist (str): Distribución de los residuos (&#39;Normal&#39;, &#39;t&#39;, etc.).</span>
<span class="sd">    - rescale (bool): Si se debe reescalar los datos.</span>
<span class="sd">    </span>
<span class="sd">    Retorna:</span>
<span class="sd">    - best_order (tuple): Mejor combinación de (p, o, q).</span>
<span class="sd">    - best_mae (float): Mejor MAE obtenido.</span>
<span class="sd">    - best_predicted_variance (np.ndarray): Pronósticos de la varianza condicional del mejor modelo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">best_mae</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">best_order</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">best_predicted_variance</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="c1"># Iterar sobre todas las combinaciones posibles de (p, o, q)</span>
    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">p_range</span><span class="p">,</span> <span class="n">o_range</span><span class="p">,</span> <span class="n">q_range</span><span class="p">):</span>
        <span class="c1"># Evitar combinaciones no válidas donde p + o + q == 0</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">predicted_variance</span><span class="p">,</span> <span class="n">mae</span> <span class="o">=</span> <span class="n">garch_forecast_variance</span><span class="p">(</span>
            <span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span>
            <span class="n">mean_model</span><span class="o">=</span><span class="n">mean_model</span><span class="p">,</span>
            <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
            <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
            <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span>
        <span class="p">)</span>
        
        <span class="c1"># Actualizar el mejor modelo si se encuentra un MAE menor</span>
        <span class="k">if</span> <span class="n">mae</span> <span class="o">&lt;</span> <span class="n">best_mae</span><span class="p">:</span>
            <span class="n">best_mae</span> <span class="o">=</span> <span class="n">mae</span>
            <span class="n">best_order</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
            <span class="n">best_predicted_variance</span> <span class="o">=</span> <span class="n">predicted_variance</span>
            
    <span class="k">return</span> <span class="n">best_order</span><span class="p">,</span> <span class="n">best_mae</span><span class="p">,</span> <span class="n">best_predicted_variance</span>

<span class="c1"># Función para realizar el tuning del modelo GARCH</span>
<span class="k">def</span> <span class="nf">garch_model_tuning_variance</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">p_max</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">o_max</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">q_max</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">mean_model</span><span class="o">=</span><span class="s1">&#39;HAR&#39;</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Realiza el tuning de hiperparámetros para el modelo GARCH buscando minimizar el MAE de las varianzas.</span>
<span class="sd">    </span>
<span class="sd">    Parámetros:</span>
<span class="sd">    - train (pd.Series): Serie temporal de entrenamiento.</span>
<span class="sd">    - test (pd.Series): Serie temporal de prueba (debe contener las varianzas reales).</span>
<span class="sd">    - p_max (int): Valor máximo para el parámetro p.</span>
<span class="sd">    - o_max (int): Valor máximo para el parámetro o.</span>
<span class="sd">    - q_max (int): Valor máximo para el parámetro q.</span>
<span class="sd">    - mean_model (str): Modelo para la media (&#39;Constant&#39;, &#39;AR&#39;, &#39;HAR&#39;, etc.).</span>
<span class="sd">    - lags (int): Número de lags para el modelo HAR.</span>
<span class="sd">    - dist (str): Distribución de los residuos (&#39;Normal&#39;, &#39;t&#39;, etc.).</span>
<span class="sd">    - rescale (bool): Si se debe reescalar los datos.</span>
<span class="sd">    </span>
<span class="sd">    Retorna:</span>
<span class="sd">    - best_order (tuple): Mejor combinación de (p, o, q).</span>
<span class="sd">    - best_mae (float): Mejor MAE obtenido.</span>
<span class="sd">    - best_predicted_variance (np.ndarray): Pronósticos de la varianza condicional del mejor modelo.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">o_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">o_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">q_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">best_order</span><span class="p">,</span> <span class="n">best_mae</span><span class="p">,</span> <span class="n">best_predicted_variance</span> <span class="o">=</span> <span class="n">garch_optimizer_variance</span><span class="p">(</span>
        <span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">p_range</span><span class="p">,</span> <span class="n">o_range</span><span class="p">,</span> <span class="n">q_range</span><span class="p">,</span>
        <span class="n">mean_model</span><span class="o">=</span><span class="n">mean_model</span><span class="p">,</span>
        <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
        <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">best_order</span><span class="p">,</span> <span class="n">best_mae</span><span class="p">,</span> <span class="n">best_predicted_variance</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_params</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
    <span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_val_test</span><span class="p">(</span><span class="n">timeserie</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span>
    <span class="n">best_order</span><span class="p">,</span> <span class="n">best_mae</span><span class="p">,</span> <span class="n">best_predicted_mean</span> <span class="o">=</span> <span class="n">garch_model_tuning_variance</span><span class="p">(</span>
        <span class="n">train</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span>
        <span class="n">p_max</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
        <span class="n">o_max</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">q_max</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">mean_model</span><span class="o">=</span><span class="s1">&#39;HAR&#39;</span><span class="p">,</span>
        <span class="n">lags</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">,</span>
        <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">best_params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;window&#39;</span><span class="p">:</span> <span class="n">window</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span> <span class="p">:</span> <span class="n">best_order</span><span class="p">})</span>
<span class="n">best_params</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[{&#39;window&#39;: 7, &#39;order&#39;: (0, 2, 3)},
 {&#39;window&#39;: 14, &#39;order&#39;: (3, 1, 3)},
 {&#39;window&#39;: 21, &#39;order&#39;: (0, 1, 5)},
 {&#39;window&#39;: 28, &#39;order&#39;: (1, 3, 0)}]
</pre></div>
</div>
</div>
</div>
</section>
<section id="testing">
<h4>TESTING<a class="headerlink" href="#testing" title="Link to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">best_params</span><span class="p">:</span>
    <span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_val_test</span><span class="p">(</span><span class="n">timeserie</span><span class="p">,</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;window&quot;</span><span class="p">])</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;order&quot;</span><span class="p">]</span>
    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;p style=&quot;color: red; font-size: 20px;&quot;&gt;Resultados de Testing para ventana de: </span><span class="si">{</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;window&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&lt;/p&gt;&#39;</span><span class="p">))</span>
    <span class="n">to_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">])</span>
    <span class="c1">#to_train = to_train.to_list()</span>
    <span class="n">to_pred</span> <span class="o">=</span> <span class="n">test</span>
    <span class="c1"># to_pred = to_pred.tolist()</span>

    <span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">order</span>
    <span class="n">am_best</span> <span class="o">=</span> <span class="n">arch_model</span><span class="p">(</span>
    <span class="n">train</span><span class="p">,</span>
    <span class="n">mean</span><span class="o">=</span><span class="s1">&#39;HAR&#39;</span><span class="p">,</span>
    <span class="n">vol</span><span class="o">=</span><span class="s1">&#39;Garch&#39;</span><span class="p">,</span>
    <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
    <span class="n">o</span><span class="o">=</span><span class="n">o</span><span class="p">,</span>
    <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span>
    <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">,</span>
    <span class="n">lags</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">res_best</span> <span class="o">=</span> <span class="n">am_best</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
    <span class="n">forecasts_best</span> <span class="o">=</span> <span class="n">res_best</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">horizon</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">to_pred</span><span class="p">))</span>

    <span class="c1"># Extraer las predicciones de la varianza condicional</span>
    <span class="n">predicted_variance_best</span> <span class="o">=</span> <span class="n">forecasts_best</span><span class="o">.</span><span class="n">variance</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">predicted_variance_best</span>

    <span class="n">residuals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_pred</span><span class="p">)</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">forecast_accuracy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_pred</span><span class="p">),</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;ARIMA_ROLLING&#39;</span><span class="p">,[</span><span class="mi">5</span><span class="p">],</span><span class="n">window_str</span><span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="s1">&#39;window&#39;</span><span class="p">])</span>
    <span class="c1">#model_summary = pd.concat([model_summary, metrics])</span>
    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;p style=&quot;color: red; font-size: 15px;&quot;&gt;Metricas&lt;/p&gt;&#39;</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
    <span class="n">pred</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pred</span><span class="p">)))</span>
    <span class="n">pred</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">test</span><span class="o">.</span><span class="n">index</span>
    <span class="n">plot_model</span><span class="p">(</span><span class="n">train</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">test</span><span class="p">,</span><span class="n">pred</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;SSE&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><p style="color: red; font-size: 20px;">Resultados de Testing para ventana de: 7</p></div><div class="output text_html"><p style="color: red; font-size: 15px;">Metricas</p></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>               model  window       MAE       MSE      MAPE      RMSE  \
train  ARIMA_ROLLING       7  0.007971  0.000126  0.372941  0.011235   

             R2  Ljung-Box p-value  Jarque-Bera p-value  
train  0.452529           0.069855             0.630616  
</pre></div>
</div>
<div class="output text_html"><p style="color: red; font-size: 20px;">Resultados de Testing para ventana de: 14</p></div><div class="output text_html"><p style="color: red; font-size: 15px;">Metricas</p></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>               model  window       MAE       MSE      MAPE      RMSE  \
train  ARIMA_ROLLING      14  0.018126  0.000567  0.686467  0.023806   

             R2  Ljung-Box p-value  Jarque-Bera p-value  
train -1.004941           0.000381             0.543264  
</pre></div>
</div>
<div class="output text_html"><p style="color: red; font-size: 20px;">Resultados de Testing para ventana de: 21</p></div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\Users\andre\miniconda3\envs\ml_env\lib\site-packages\arch\univariate\base.py:766: ConvergenceWarning:

The optimizer returned code 4. The message is:
Inequality constraints incompatible
See scipy.optimize.fmin_slsqp for code meaning.
</pre></div>
</div>
<div class="output text_html"><p style="color: red; font-size: 15px;">Metricas</p></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>               model  window       MAE       MSE    MAPE      RMSE        R2  \
train  ARIMA_ROLLING      21  0.024711  0.001187  0.6932  0.034447 -0.874639   

       Ljung-Box p-value  Jarque-Bera p-value  
train           0.000013             0.263367  
</pre></div>
</div>
<div class="output text_html"><p style="color: red; font-size: 20px;">Resultados de Testing para ventana de: 28</p></div><div class="output text_html"><p style="color: red; font-size: 15px;">Metricas</p></div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>               model  window       MAE       MSE      MAPE      RMSE       R2  \
train  ARIMA_ROLLING      28  0.029318  0.001342  0.659943  0.036633 -3.52389   

       Ljung-Box p-value  Jarque-Bera p-value  
train       1.516195e-07             0.236185  
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p><strong>Ventana de 7</strong>:</p>
<ul>
<li><p><strong>Métricas de Error</strong>: El modelo GARCH muestra un bajo error en MAE y MSE, indicando una buena precisión en la captura de la volatilidad a corto plazo.</p></li>
<li><p><strong>Pruebas de Diagnóstico</strong>: La prueba de Ljung-Box muestra que persisten algunas autocorrelaciones, mientras que la prueba de Jarque-Bera indica normalidad en los residuos, lo que sugiere una buena modelación de la estructura de los datos volátiles.</p></li>
</ul>
</li>
<li><p><strong>Ventana de 14</strong>:</p>
<ul>
<li><p><strong>Métricas de Error</strong>: Se observa un ligero incremento en MAE y MSE, pero la precisión sigue siendo adecuada para periodos de volatilidad de mediano alcance.</p></li>
<li><p><strong>Pruebas de Diagnóstico</strong>: Se mantienen algunas autocorrelaciones significativas, y Jarque-Bera confirma que los residuos siguen una distribución normal.</p></li>
</ul>
</li>
<li><p><strong>Ventana de 21</strong>:</p>
<ul>
<li><p><strong>Métricas de Error</strong>: Incremento en los errores MAE y MSE, indicando una ligera pérdida de precisión a medida que se extiende el horizonte de predicción.</p></li>
<li><p><strong>Pruebas de Diagnóstico</strong>: Ljung-Box detecta autocorrelaciones residuales, mientras que Jarque-Bera no rechaza la normalidad.</p></li>
</ul>
</li>
<li><p><strong>Ventana de 28</strong>:</p>
<ul>
<li><p><strong>Métricas de Error</strong>: Los errores aumentan aún más, reflejando una menor precisión en la predicción de la volatilidad a largo plazo.</p></li>
<li><p><strong>Pruebas de Diagnóstico</strong>: Las autocorrelaciones residuales persisten y la normalidad es aceptada en los residuos.</p></li>
</ul>
</li>
</ul>
<p><strong>Conclusión</strong>:</p>
<ul class="simple">
<li><p>El modelo GARCH es efectivo en capturar la volatilidad a corto y mediano plazo, con buena precisión en ventanas más cortas (7 y 14).</p></li>
<li><p>Para ventanas largas, el desempeño decrece ligeramente, pero el modelo sigue capturando los picos de volatilidad. Las autocorrelaciones residuales sugieren que podría mejorarse el ajuste para capturar completamente la estructura de volatilidad.</p></li>
</ul>
</section>
</section>
<section id="garch-con-rolling">
<h3>GARCH CON ROLLING<a class="headerlink" href="#garch-con-rolling" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ignorar advertencias de convergencia y otros warnings de arch</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">garch_forecast_variance</span><span class="p">(</span><span class="n">train</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">mean_model</span><span class="o">=</span><span class="s1">&#39;HAR&#39;</span><span class="p">,</span> <span class="n">lags</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">,</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ajusta un modelo GARCH con los parámetros especificados y genera un pronóstico de la varianza para el siguiente paso.</span>
<span class="sd">    </span>
<span class="sd">    Parámetros:</span>
<span class="sd">    - train (pd.Series): Serie temporal de entrenamiento (varianzas reales).</span>
<span class="sd">    - p (int): Orden ARCH.</span>
<span class="sd">    - o (int): Orden de términos asimétricos (Leverage term).</span>
<span class="sd">    - q (int): Orden GARCH.</span>
<span class="sd">    - mean_model (str): Modelo para la media (&#39;Constant&#39;, &#39;AR&#39;, &#39;HAR&#39;, etc.).</span>
<span class="sd">    - lags (int): Número de lags para el modelo HAR.</span>
<span class="sd">    - dist (str): Distribución de los residuos (&#39;Normal&#39;, &#39;t&#39;, etc.).</span>
<span class="sd">    - rescale (bool): Si se debe reescalar los datos.</span>
<span class="sd">    </span>
<span class="sd">    Retorna:</span>
<span class="sd">    - predicted_variance (float): Pronóstico de la varianza condicional para el siguiente paso.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Configurar el modelo GARCH</span>
        <span class="n">am</span> <span class="o">=</span> <span class="n">arch_model</span><span class="p">(</span>
            <span class="n">train</span><span class="p">,</span>
            <span class="n">mean</span><span class="o">=</span><span class="n">mean_model</span><span class="p">,</span>
            <span class="n">vol</span><span class="o">=</span><span class="s1">&#39;Garch&#39;</span><span class="p">,</span>
            <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
            <span class="n">o</span><span class="o">=</span><span class="n">o</span><span class="p">,</span>
            <span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span>
            <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
            <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
            <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span>
        <span class="p">)</span>
        
        <span class="c1"># Ajustar el modelo</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">am</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">disp</span><span class="o">=</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        
        <span class="c1"># Generar pronóstico para el siguiente paso</span>
        <span class="n">forecasts</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">forecast</span><span class="p">(</span><span class="n">horizon</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Extraer la varianza condicional pronosticada para el siguiente paso</span>
        <span class="n">predicted_variance</span> <span class="o">=</span> <span class="n">forecasts</span><span class="o">.</span><span class="n">variance</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">predicted_variance</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error con p=</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">, o=</span><span class="si">{</span><span class="n">o</span><span class="si">}</span><span class="s2">, q=</span><span class="si">{</span><span class="n">q</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># Retornar NaN para manejar en la evaluación</span>

<span class="k">def</span> <span class="nf">garch_rolling_window_evaluation_best_order</span><span class="p">(</span>
    <span class="n">returns</span><span class="p">,</span>
    <span class="n">window_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
    <span class="n">p_max</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">o_max</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">q_max</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">mean_model</span><span class="o">=</span><span class="s1">&#39;HAR&#39;</span><span class="p">,</span>
    <span class="n">lags</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
    <span class="n">dist</span><span class="o">=</span><span class="s1">&#39;Normal&#39;</span><span class="p">,</span>
    <span class="n">rescale</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Realiza una evaluación utilizando una ventana de rolling para modelos GARCH, optimizando p, o, q en cada ventana</span>
<span class="sd">    y acumulando el MAE para cada combinación. Finalmente, selecciona el best_order con el MAE acumulado más bajo.</span>
<span class="sd">    </span>
<span class="sd">    Parámetros:</span>
<span class="sd">    - returns (pd.Series): Serie temporal de retornos.</span>
<span class="sd">    - window_size (int): Tamaño de la ventana de entrenamiento.</span>
<span class="sd">    - p_max (int): Valor máximo para el parámetro p.</span>
<span class="sd">    - o_max (int): Valor máximo para el parámetro o.</span>
<span class="sd">    - q_max (int): Valor máximo para el parámetro q.</span>
<span class="sd">    - mean_model (str): Modelo para la media (&#39;Constant&#39;, &#39;AR&#39;, &#39;HAR&#39;, etc.).</span>
<span class="sd">    - lags (int): Número de lags para el modelo HAR.</span>
<span class="sd">    - dist (str): Distribución de los residuos (&#39;Normal&#39;, &#39;t&#39;, etc.).</span>
<span class="sd">    - rescale (bool): Si se debe reescalar los datos.</span>
<span class="sd">    </span>
<span class="sd">    Retorna:</span>
<span class="sd">    - best_order (tuple): Mejor combinación de (p, o, q) basada en MAE acumulado.</span>
<span class="sd">    - best_mae (float): MAE acumulado asociado al best_order.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convertir retornos a varianzas (puedes usar el cuadrado de los retornos o usar varianzas reales si las tienes)</span>
    <span class="c1"># Aquí, usamos el cuadrado de los retornos como proxy</span>
    <span class="n">variances</span> <span class="o">=</span> <span class="n">returns</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="c1"># Definir rangos de p, o, q</span>
    <span class="n">p_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">o_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">o_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">q_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">q_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># Inicializar diccionarios para acumular MAE por combinación</span>
    <span class="n">mae_accumulated</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">count_accumulated</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">p_range</span><span class="p">,</span> <span class="n">o_range</span><span class="p">,</span> <span class="n">q_range</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>  <span class="c1"># Evitar combinaciones inválidas</span>
        <span class="n">mae_accumulated</span><span class="p">[(</span><span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">q</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">count_accumulated</span><span class="p">[(</span><span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">q</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Número de pasos en el conjunto de rolling</span>
    <span class="n">n_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span> <span class="o">-</span> <span class="n">window_size</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Iniciando la evaluación con ventana de rolling...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">)):</span>
        <span class="c1"># Definir la ventana de entrenamiento</span>
        <span class="n">train_window</span> <span class="o">=</span> <span class="n">variances</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">]</span>
        
        <span class="c1"># Definir el valor real de varianza para el siguiente paso</span>
        <span class="n">true_variance</span> <span class="o">=</span> <span class="n">variances</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">]</span>
        
        <span class="c1"># Iterar sobre todas las combinaciones posibles de (p, o, q)</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">p_range</span><span class="p">,</span> <span class="n">o_range</span><span class="p">,</span> <span class="n">q_range</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">o</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">q</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Evitar combinaciones inválidas</span>
            
            <span class="c1"># Generar el pronóstico de la varianza</span>
            <span class="n">predicted_variance</span> <span class="o">=</span> <span class="n">garch_forecast_variance</span><span class="p">(</span>
                <span class="n">train_window</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span>
                <span class="n">mean_model</span><span class="o">=</span><span class="n">mean_model</span><span class="p">,</span>
                <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
                <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
                <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span>
            <span class="p">)</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">predicted_variance</span><span class="p">):</span>
                <span class="c1"># Calcular el MAE para este paso y combinación</span>
                <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">([</span><span class="n">true_variance</span><span class="p">],</span> <span class="p">[</span><span class="n">predicted_variance</span><span class="p">])</span>
                
                <span class="c1"># Acumular el MAE</span>
                <span class="n">mae_accumulated</span><span class="p">[(</span><span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">q</span><span class="p">)]</span> <span class="o">+=</span> <span class="n">mae</span>
                <span class="n">count_accumulated</span><span class="p">[(</span><span class="n">p</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">q</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Si el pronóstico falló, no se acumula el MAE</span>
                <span class="k">continue</span>
    
    <span class="c1"># Calcular el MAE promedio por combinación</span>
    <span class="n">mae_average</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">mae_accumulated</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">count_accumulated</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mae_average</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mae_accumulated</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="n">count_accumulated</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mae_average</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>  <span class="c1"># Asignar infinito si no se evaluó ninguna vez</span>
    
    <span class="c1"># Seleccionar la combinación con el MAE promedio más bajo</span>
    <span class="n">best_order</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mae_average</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">mae_average</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
    <span class="n">best_mae</span> <span class="o">=</span> <span class="n">mae_average</span><span class="p">[</span><span class="n">best_order</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">best_order</span><span class="p">,</span> <span class="n">best_mae</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_params</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
    <span class="n">train</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">train_val_test</span><span class="p">(</span><span class="n">timeserie</span><span class="p">,</span> <span class="n">window</span><span class="p">)</span>
    <span class="c1"># Parámetros de la ventana de rolling</span>
    <span class="n">window_size</span> <span class="o">=</span> <span class="mi">3000</span>  <span class="c1"># Tamaño de la ventana de entrenamiento</span>
    <span class="n">p_max</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">o_max</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">q_max</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">mean_model</span> <span class="o">=</span> <span class="s1">&#39;HAR&#39;</span>
    <span class="n">lags</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="s1">&#39;Normal&#39;</span>
    <span class="n">rescale</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">best_order</span><span class="p">,</span> <span class="n">best_mae</span> <span class="o">=</span> <span class="n">garch_rolling_window_evaluation_best_order</span><span class="p">(</span>
        <span class="n">train</span><span class="p">,</span>
        <span class="n">window_size</span><span class="o">=</span><span class="n">window_size</span><span class="p">,</span>
        <span class="n">p_max</span><span class="o">=</span><span class="n">p_max</span><span class="p">,</span>
        <span class="n">o_max</span><span class="o">=</span><span class="n">o_max</span><span class="p">,</span>
        <span class="n">q_max</span><span class="o">=</span><span class="n">q_max</span><span class="p">,</span>
        <span class="n">mean_model</span><span class="o">=</span><span class="n">mean_model</span><span class="p">,</span>
        <span class="n">lags</span><span class="o">=</span><span class="n">lags</span><span class="p">,</span>
        <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
        <span class="n">rescale</span><span class="o">=</span><span class="n">rescale</span>
    <span class="p">)</span>
    <span class="n">best_params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;window&#39;</span><span class="p">:</span> <span class="n">window</span><span class="p">,</span> <span class="s1">&#39;order&#39;</span> <span class="p">:</span> <span class="n">best_order</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">best_params</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./chapters"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="punto2_c_volatilidad.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Parcial Punto 2 - VOLATILIDAD</p>
      </div>
    </a>
    <a class="right-next"
       href="deeplearning.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Modelos de Deep Learning</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#librerias-y-funciones">LIBRERIAS Y FUNCIONES</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#datos">DATOS</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#garch-sin-rolling">GARCH SIN ROLLING</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#implementacion">IMPLEMENTACIÓN</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#testing">TESTING</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#garch-con-rolling">GARCH CON ROLLING</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>